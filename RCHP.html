<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RCHP</title>
<script src="https://viitaliigithub.github.io/HTML/JsBarcode.all.min.js"></script>
<style>
body, ul, li { margin: 1px; padding: 1px; list-style: none; }
li { margin:6px 0; }
a.product-link { text-decoration:none; cursor:pointer; }
.comment { color:#ff0000; margin-top:4px; }
img.barcode { max-width: 100%; height:auto; display:block; margin-top:4px; }
#searchInput { margin-bottom: 10px; width: 99%; padding: 2px; font-size: 16px; }
.page { display: none; }
.page.active { display: block; }
#passwordInput, #loginButton { margin-bottom: 10px; padding: 2px; font-size: 16px; }
</style>
</head>
<body>

<!-- Page 1: password / location -->
<div class="page" id="page1">
    <p id="versionPage1" style="text-align:center;"></p>
    <p>Enter Password:</p>
    <input type="password" id="passwordInput" />
    <button id="loginButton">Enter</button>
    <p style="text-align:center;" id="currentLocation"></p>
</div>

<!-- Page 2: product list -->
<div class="page" id="page2">
    <p id="versionPage2" style="text-align:center;"></p>

    <!-- Чекбокс для просроченных дат -->
    <label style="display:block; text-align:center; margin-bottom:6px;">
        <input type="checkbox" id="extendExpired" /> Adjust expired
    </label>

    <input type="text" id="searchInput" placeholder="Search..." />
    <ul id="linkList"></ul>
</div>

<script>
var currentImg = null;
var currentComment = null;

function createBarcode(base, expDate, batch){
    if(!expDate) return base;
    var parts = expDate.split('.');
    if(parts.length<3) return base;
    var DD = parts[0], MM = parts[1], YY = parts[2].slice(-2);
    var exp = new Date(parts[2], parseInt(MM,10)-1, DD);
    var now = new Date();
    if(exp < now) return base;
    return base + '15' + YY + MM + DD + '10' + batch;
}

function showImage(event, base, expDate, batch, linkEl) {
    if(event) event.preventDefault();

    if(currentImg) currentImg.remove();
    if(currentComment) currentComment.remove();
    currentImg = null;
    currentComment = null;

    var container = document.createElement('div');
    container.className = 'comment';

    var dateInput = document.createElement('input');
    dateInput.type = 'text';
    dateInput.value = expDate;
    dateInput.size = 10;
    dateInput.style.marginRight = '6px';

    var batchInput = document.createElement('input');
    batchInput.type = 'text';
    batchInput.value = batch;
    batchInput.size = 8;

    container.textContent = 'Exp. date: ';
    container.appendChild(dateInput);
    container.appendChild(document.createTextNode(' Batch: '));
    container.appendChild(batchInput);

    linkEl.parentNode.insertBefore(container, linkEl.nextSibling);

    var img = document.createElement('img');
    img.className = 'barcode';
    linkEl.parentNode.insertBefore(img, container.nextSibling);

    function validateDate(dateStr) {
        var re = /^\d{2}\.\d{2}\.\d{4}$/;
        if(!re.test(dateStr)) return false;
        var parts = dateStr.split('.');
        var d = parseInt(parts[0],10), m = parseInt(parts[1],10), y = parseInt(parts[2],10);
        var dt = new Date(y, m-1, d);
        return dt && dt.getDate()===d && dt.getMonth()===m-1 && dt.getFullYear()===y;
    }

    function updateBarcode() {
        var dateValid = validateDate(dateInput.value);
        dateInput.style.borderColor = dateValid ? '' : 'red';

        var correctedDate = dateInput.value;

        if(dateValid){
            var parts = correctedDate.split('.');
            var exp = new Date(parts[2], parseInt(parts[1],10)-1, parts[0],23,59,59);
            var extendCheckbox = document.getElementById('extendExpired');
            if(exp < new Date() && extendCheckbox.checked){
                while(exp < new Date()){
                    exp.setMonth(exp.getMonth() + 2);
                }
                var dd = String(exp.getDate()).padStart(2,'0');
                var mm = String(exp.getMonth()+1).padStart(2,'0');
                var yyyy = exp.getFullYear();
                correctedDate = `${dd}.${mm}.${yyyy}`;
                dateInput.value = correctedDate;
            }

            var fullBarcode = createBarcode(base, correctedDate, batchInput.value);
            try { JsBarcode(img, fullBarcode, {format:"CODE128", displayValue:true, fontSize:18, margin:5}); }
            catch(e){ console.error(e); }
        }
    }

    var partsCheck = dateInput.value.split('.');
    var expCheck = new Date(partsCheck[2], parseInt(partsCheck[1],10)-1, partsCheck[0],23,59,59);
    if(expCheck < new Date() && !document.getElementById('extendExpired').checked){
        alert("Termin waznosci minal! Prosze zeskanowac kod z kartonika!");
    }

    updateBarcode();
    dateInput.addEventListener('input', updateBarcode);
    batchInput.addEventListener('input', updateBarcode);

    currentImg = img;
    currentComment = container;
}

var searchInput = document.getElementById('searchInput');
searchInput.addEventListener('focus', function() {
    if(currentImg) currentImg.remove();
    if(currentComment) currentComment.remove();
    currentImg = null;
    currentComment = null;
    this.select();
});
searchInput.addEventListener('input', function() {
    var q = this.value.trim().toLowerCase();
    var items = document.querySelectorAll('#linkList li');
    items.forEach(function(li){
        li.style.display = (li.dataset.name.toLowerCase().includes(q)) ? 'block':'none';
    });
});

function encryptPassword(password){
    var out=''; for(var i=0;i<password.length;i++) out+=String.fromCharCode(password.charCodeAt(i)+1);
    return out;
}
function showPage(n){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    var el = document.getElementById('page'+n); if(el) el.classList.add('active');
}
function getLocation(){
    if(navigator.geolocation) navigator.geolocation.getCurrentPosition(checkLocation, showPasswordPage, {timeout:10000});
    else showPasswordPage();
}
function checkLocation(pos){
    var lat=pos.coords.latitude, lon=pos.coords.longitude;
    var dist=calculateDistance(lat, lon, 52.1639283, 20.9299692);
    if(dist<=1) showPage(2); else showPasswordPage();
    var cur=document.getElementById('currentLocation');
    if(cur) cur.textContent = lat.toFixed(6)+', '+lon.toFixed(6);
}
function showPasswordPage(){ showPage(1); }
function calculateDistance(lat1, lon1, lat2, lon2){
    var R=6371;
    var dLat=(lat2-lat1)*Math.PI/180;
    var dLon=(lon2-lon1)*Math.PI/180;
    var a=Math.sin(dLat/2)*Math.sin(dLat/2)+
        Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
        Math.sin(dLon/2)*Math.sin(dLon/2);
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

document.getElementById('loginButton').addEventListener('click', function(){
    var val=document.getElementById('passwordInput').value||'';
    if(encryptPassword(val)==='73319739') showPage(2); else alert('Invalid password!');
});
document.getElementById('passwordInput').addEventListener('keydown', function(e){
    if(e.key==='Enter') document.getElementById('loginButton').click();
});
setInterval(()=>location.reload(),900000);

function loadProductList(){
    fetch('https://viitaliigithub.github.io/HTML/RCHP_Data.txt',{cache:'no-store'})
    .then(r=>r.text())
    .then(text=>{
        var lines=text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
        if(lines.length===0) return;

        var versionText = lines[0];
        document.getElementById('versionPage1').textContent = versionText;
        document.getElementById('versionPage2').textContent = versionText;

        var ul=document.getElementById('linkList'); 
        ul.innerHTML='';
        lines.slice(1).forEach((line,idx)=>{
            var parts=line.split('\t'); 
            if(parts.length<4) return;
            var name=parts[0].trim(), base=parts[1].trim(), exp=parts[2].trim(), batch=parts[3].trim();
            var full=createBarcode(base,exp,batch);

            var li=document.createElement('li'); li.dataset.name=name;
            var a=document.createElement('a'); 
            a.className='product-link'; a.href='#'; a.textContent=name;

            var extendCheckbox = document.getElementById('extendExpired');
            if(exp){
                var p=exp.split('.');
                var expDate = new Date(p[2], parseInt(p[1],10)-1, p[0],23,59,59);
                if(expDate < new Date()){
                    a.style.color = extendCheckbox.checked ? '#a020f0' : '#ff0000';
                } else { a.style.color='#006'; }
            } else { a.style.color='#006'; }

            a.addEventListener('click', e=>showImage(e, base, exp, batch, a));
            li.appendChild(a);
            ul.appendChild(li);
        });
    })
    .catch(err=>console.error('Error loading RCHP_Data.txt:',err));
}

document.getElementById('extendExpired').addEventListener('change', loadProductList);

window.addEventListener('load', function(){
    getLocation();
    loadProductList();
});
</script>

</body>
</html>
